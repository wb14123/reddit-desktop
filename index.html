<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.26/vue.min.js"></script>
    <script src="https://use.fontawesome.com/ee996d3f32.js"></script>
  </head>
  <body>
    <div id="main">
      <!--<div id="subs" class="col">
        Subs
      </div>-->
      <div id="catalog" class="col">
        <div class="post-item" v-for="post in posts" v-bind:class="{'selected':$index==selected_index}" href="#" v-on:click="openPost($index)">
          <div class="post-subscribe-name">
            /r/{{ post.subreddit.display_name }}
          </div>
          <div class="post-title">
            {{ post.title }}
          </div>
          <div class="post-url">
            From: {{ post.url }}
          </div>
          <div class="post-author">
            Submmited by <span class="author-name">{{ post.author.name }}</span> at {{new Date(post.created_utc * 1000).toLocaleString()}}
          </div>
          <div class="post-buttom">
            <div class="post-ops">
              <span class="fa fa-thumbs-up"></span>
              <span class="fa fa-thumbs-down"></span>
              <span class="fa fa-bookmark"></span>
              <span class="fa fa-trash"></span>
            </div>
            <div class="post-stats">
              <span class="fa fa-comment"></span>{{ post.num_comments }}
              <span class="fa fa-star"></span>{{ post.score }}
            </div>
          </div>
        </div>
      </div>
      <div id="article" class="col" v-bind:class="{'webview-hidden':hidePost}">
        <webview id="web" src="loading.html"></webview>
      </div>
      <!--
      <div id="comments" class="col">
        Comments
      </div>
      -->
    </div>


    <script>

      const snoowrap = require('snoowrap');
      const webview = document.getElementById("web")

      var v = new Vue({
        el: '#main',
        data: {
          posts: [],
          hidePost: true,
          comments: [],
          selected_index: -1
        },
        methods: {
          openPost: function (index) {
            if (this.selected_index == index) {
              this.hidePost = true
              this.selected_index = -1
              return
            }
            this.hidePost = false
            webview.loadURL(this.posts[index].url)
            this.selected_index = index
            this.posts[index].expand_replies({limit: 100, depth: 1}).then(comments => {
              this.comments = comments})
          }
        }
      })

      var r = null

      function renderList(r) {
        r.get_hot({limit: 20}).then(posts => v.$set('posts', posts))
      }

      const {ipcRenderer} = require('electron')
      ipcRenderer.on('reddit-token', (event, token) => {
        console.log(token)

        r = new snoowrap({
          'user_agent': 'Reddit Desktop',
          'access_token': token
        })
        r.get_me().then(console.log)

        renderList(r)
      })

    </script>
  </body>

</html>
